<?php
/**
* @file
* A description of what your module does.
*/

define('GF_USER_ROLE_MANAGER_GARDENER_ID', 18);
define('GF_USER_ROLE_WHOLESALE_CUSTOMER_ID', 19);


/**
 * Implements hook_menu().
 */
function gf_discount_menu() {
  $items = [];
  // Страница настроек модуля.
  $items['admin/config/gf-discount'] = [
    'title' => 'GF-Discount ',
    'description' => 'Gf-Discount module settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['gf_discount_settings_form'],
    'access arguments' => ['access administration pages'],
    'file' => 'gf_discount.admin.inc',
  ];
  return $items;
}


/**
 * Implements hook_uc_cart_alter().
 */
function gf_discount_uc_cart_alter(&$items) {
  $cart_total = gf_discount_get_cart_total_sum($items);
  // Получаем скидку(в процентах) для "новичка".
  $newbie_discount = gf_discount_get_newbie_discount($items);
  if ($newbie_discount && !isset($_SESSION['gf_discount_newbie_msg_shown'])) {
    // Если таковая есть, радуем пользователя сообщением, как ему повезло.
    $msg = t('You received a promotional discount of !percent % on all products in your shopping cart',
    ['!percent' => $newbie_discount]);
    drupal_set_message($msg);
    $_SESSION['gf_discount_newbie_msg_shown'] = TRUE;
  }

  // Десятипроцентная скидка для пользователей определенных блатных ролей.
  $extra_10 = (user_has_role(GF_USER_ROLE_MANAGER_GARDENER_ID) 
    or user_has_role(GF_USER_ROLE_WHOLESALE_CUSTOMER_ID));

  foreach ($items as $key => $item) {
    $discount_percent = $extra_10 ? 10 : 0; // процент блатным

    if ($newbie_discount) {
      $discount_percent += $newbie_discount; // процент новичкам
    }

    if (isset($item->field_discount['und'])) {
      $tid = $item->field_discount['und'][0]['tid'];
      $discount_term = taxonomy_term_load($tid);
      $discount_percent += (int) $discount_term->name; // процент за акционный товар
    }

    if ($discount_percent) {
      $current_price = $item->price;
      $items[$key]->price = $items[$key]->sell_price = $current_price - (($current_price / 100) * $discount_percent);
    }
  }
}

/**
 * Проверка на пользователя-новичка(еще не делал заказов).
 *
 * @return bool
 *   Возвращаем единичку, если заказов еще не было.
 */
function gf_discount_check_newbie($uid=NULL) {
  if (is_null($uid)) {
    global $user;
    $uid = $user->uid;
  }

  if ($uid < 2) return; // Юзер 1 нам тоже не интересен.
  $result = db_query('SELECT 1 FROM {uc_orders} WHERE uid = :uid',
    [':uid' => $uid])->fetchField();

  return !$result;
}


/**
 * Получаем общую сумму заказа.
 *
 * @param array $cart_items
 * @return int
 */
function gf_discount_get_cart_total_sum($cart_items) {
  $sum = 0;
  foreach($cart_items as $item) {
    $sum += $item->qty * $item->price;
  }
  return $sum;
}


/**
 * Получаем дисконт для новочела.
 *
 * @param array $cart_items
 *   массив с элементами корзины
 * @param int $uid
 * @return int
 *   вовращаем процент скидки, или ноль, если не положено
 */
function gf_discount_get_newbie_discount($cart_items, $uid=NULL) {
  $discount = 0;
  $is_newbie = gf_discount_check_newbie($uid);

  // if (!$is_newbie) 
  //   return $discount;

  $cart_total = gf_discount_get_cart_total_sum($cart_items) / 1000;
  $newbie_discounts = variable_get('gf_discount_newbie_discounts', []);
  krsort($newbie_discounts); // сортируем по нисходящей
  foreach(array_keys($newbie_discounts) as $sum) {
    if ($cart_total >= $sum) {
      $discount = $newbie_discounts[$sum];
      break;
    }
  }
  return $discount;
}
